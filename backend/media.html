<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media - clip.abaj.ai</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #fff;
            color: #333;
            padding: 20px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: normal;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls label {
            font-size: 14px;
        }
        
        .controls input {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            cursor: pointer;
            background: #007bff;
            color: white;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-download {
            background: #28a745;
        }
        
        .btn-download:hover {
            background: #218838;
        }
        
        .btn-upload {
            background: #17a2b8;
        }
        
        .btn-upload:hover {
            background: #138496;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn-admin {
            background: #6c757d;
        }
        
        .btn-admin:hover {
            background: #545b62;
        }
        
        .btn-delete {
            background: #dc3545;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .image-item {
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            transition: box-shadow 0.2s;
            background: #f9f9f9;
            position: relative;
        }
        
        .image-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .image-item.selected {
            border: 3px solid #dc3545;
        }
        
        .image-wrapper {
            width: 100%;
            aspect-ratio: 1;
            overflow: hidden;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-info {
            padding: 6px 8px;
            font-size: 12px;
        }
        
        .image-name {
            word-break: break-all;
            color: #0066cc;
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
        }
        
        .checkbox-wrapper {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            display: none;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        body.admin-mode .checkbox-wrapper {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .count {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        /* Modal/Preview Overlay */
        .preview-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .preview-overlay.active {
            display: flex;
        }
        
        .preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        
        .preview-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .preview-close {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        .preview-close:hover {
            background: white;
        }
        
        .preview-download {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1001;
            transition: background 0.2s;
        }
        
        .preview-download:hover {
            background: #218838;
        }
        
        .preview-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: background 0.2s, opacity 0.2s;
        }
        
        .preview-arrow:hover {
            background: white;
        }
        
        .preview-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .preview-arrow-left {
            left: 20px;
        }
        
        .preview-arrow-right {
            right: 20px;
        }
        
        .admin-controls {
            display: none;
            gap: 10px;
        }
        
        body.admin-mode .admin-controls {
            display: flex;
        }
        
        /* Login Modal */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .login-modal.active {
            display: flex;
        }
        
        .login-form {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            min-width: 300px;
        }
        
        .login-form h2 {
            margin-bottom: 20px;
        }
        
        .login-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .login-form .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .login-form .btn {
            flex: 1;
        }
    </style>
</head>
<body>
    <h1>Media</h1>
    
    <div style="margin-bottom: 15px;">
        <a href="/" style="text-decoration: none; color: #0366d6;">Home</a>
    </div>
    
    <div class="count" id="count"></div>
    
    <div class="controls">
        <label for="search">Filter:</label>
        <input type="text" id="search" placeholder="Search filenames...">
        
        <input type="file" id="fileInput" multiple accept="image/*">
        <button class="btn btn-upload" id="uploadBtn">Upload</button>
        <button class="btn btn-download" id="downloadAllBtn">Download All</button>
        <button class="btn btn-admin" id="adminBtn">Admin</button>
        <button class="btn" id="viewModeBtn" title="Change view mode">âŠž</button>
        
        <div class="admin-controls">
            <button class="btn btn-delete" id="deleteSelectedBtn">Delete Selected</button>
            <button class="btn" id="exitAdminBtn">Exit Admin</button>
        </div>
    </div>
    
    <div id="gallery" class="gallery"></div>
    <div id="loading" class="loading">Loading images...</div>

    <!-- Preview Overlay -->
    <div class="preview-overlay" id="previewOverlay">
        <button class="preview-close" id="previewClose">âœ•</button>
        <button class="preview-download btn btn-download" id="previewDownload">Download</button>
        <button class="preview-arrow preview-arrow-left" id="previewPrev">â€¹</button>
        <button class="preview-arrow preview-arrow-right" id="previewNext">â€º</button>
        <div class="preview-content">
            <img id="previewImage" src="" alt="Preview" style="display: none;">
            <video id="previewVideo" controls style="display: none; max-width: 100%; max-height: 80vh;">
                <source id="previewVideoSource" src="" type="">
                Your browser does not support video playback.
            </video>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2>Admin Login</h2>
            <input type="text" id="username" placeholder="Username" autocomplete="username">
            <input type="password" id="password" placeholder="Password" autocomplete="current-password">
            <div class="btn-group">
                <button class="btn" id="loginBtn">Login</button>
                <button class="btn btn-admin" id="cancelLoginBtn">Cancel</button>
            </div>
            <p id="loginError" style="color: red; margin-top: 10px; display: none;"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const gallery = document.getElementById('gallery');
        const loading = document.getElementById('loading');
        const searchInput = document.getElementById('search');
        const countEl = document.getElementById('count');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const adminBtn = document.getElementById('adminBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const exitAdminBtn = document.getElementById('exitAdminBtn');
        const previewOverlay = document.getElementById('previewOverlay');
        const previewImage = document.getElementById('previewImage');
        const previewClose = document.getElementById('previewClose');
        const previewDownload = document.getElementById('previewDownload');
        const loginModal = document.getElementById('loginModal');
        const loginBtn = document.getElementById('loginBtn');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        
        let allMedia = [];
        let filteredMedia = [];
        let isAdminMode = localStorage.getItem('clipAdminMode') === 'true';
        let currentPreviewItem = null;
        let viewMode = localStorage.getItem('mediaViewMode') || 'medium'; // small, medium, large, list
        
        // Restore admin state from localStorage
        if (isAdminMode) {
            document.body.classList.add('admin-mode');
        }
        
        // Fetch media from server
        async function fetchMedia() {
            try {
                const response = await fetch('/api/media/list');
                const data = await response.json();
                allMedia = data.media || [];
                filteredMedia = [...allMedia];
                renderGallery();
            } catch (error) {
                console.error('Error fetching media:', error);
                loading.innerHTML = 'Error loading media';
            }
        }
        
        function renderGallery() {
            gallery.innerHTML = '';
            
            if (filteredMedia.length === 0 && allMedia.length === 0) {
                loading.style.display = 'block';
                loading.innerHTML = 'No media found.';
                countEl.textContent = '0 items';
                return;
            }
            
            if (filteredMedia.length === 0) {
                loading.style.display = 'block';
                loading.innerHTML = 'No media match your filter.';
                countEl.textContent = `0 of ${allMedia.length} items`;
                return;
            }
            
            loading.style.display = 'none';
            countEl.textContent = filteredMedia.length === allMedia.length 
                ? `${filteredMedia.length} items` 
                : `${filteredMedia.length} of ${allMedia.length} items`;
            
            // Set gallery grid size based on view mode
            if (viewMode === 'list') {
                gallery.style.gridTemplateColumns = '1fr';
            } else {
                const sizes = {small: '100px', medium: '200px', large: '350px'};
                gallery.style.gridTemplateColumns = `repeat(auto-fill, minmax(${sizes[viewMode]}, 1fr))`;
            }
            
            filteredMedia.forEach(mediaItem => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.dataset.filename = mediaItem.name;
                item.dataset.type = mediaItem.type;
                
                // List view - text only
                if (viewMode === 'list') {
                    item.style.display = 'flex';
                    item.style.alignItems = 'center';
                    item.style.padding = '8px';
                    item.style.cursor = 'pointer';
                    item.onclick = () => openPreview(mediaItem);
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'image-checkbox';
                    checkbox.value = mediaItem.name;
                    checkbox.style.marginRight = '10px';
                    checkbox.onclick = (e) => e.stopPropagation();
                    
                    const nameSpan = document.createElement('span');
                    const typeLabel = mediaItem.type === 'video' ? 'ðŸŽ¥ ' : '';
                    nameSpan.textContent = typeLabel + mediaItem.name;
                    nameSpan.style.flexGrow = '1';
                    
                    item.appendChild(checkbox);
                    item.appendChild(nameSpan);
                    gallery.appendChild(item);
                    return;
                }
                
                // Grid views - with thumbnails
                const checkbox = document.createElement('div');
                checkbox.className = 'checkbox-wrapper';
                checkbox.innerHTML = `<input type="checkbox" class="image-checkbox" value="${mediaItem.name}">`;
                
                const mediaWrapper = document.createElement('div');
                mediaWrapper.className = 'image-wrapper';
                mediaWrapper.onclick = () => openPreview(mediaItem);
                
                // Use video thumbnail or image thumbnail
                if (mediaItem.type === 'video') {
                    // Video thumbnail placeholder
                    const videoThumb = document.createElement('div');
                    videoThumb.style.cssText = 'width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center;';
                    const playIcon = document.createElement('div');
                    playIcon.innerHTML = 'â–¶';
                    playIcon.style.cssText = 'font-size:48px;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.8);';
                    videoThumb.appendChild(playIcon);
                    mediaWrapper.appendChild(videoThumb);
                } else {
                    // Use appropriate thumbnail size
                    const thumbnailSizes = {
                        small: 'small',
                        medium: 'medium',
                        large: 'large',
                        list: 'small'
                    };
                    const thumbSize = thumbnailSizes[viewMode];
                    
                    const img = document.createElement('img');
                    img.src = `/thumbnails/${thumbSize}/${mediaItem.name}`;
                    img.alt = mediaItem.name;
                    img.loading = 'lazy';
                    img.decoding = 'async';
                    // Fallback to full image if thumbnail doesn't exist
                    img.onerror = function() {
                        this.src = `/media/${mediaItem.name}`;
                    };
                    mediaWrapper.appendChild(img);
                }
                
                const info = document.createElement('div');
                info.className = 'image-info';
                const typeLabel = mediaItem.type === 'video' ? 'ðŸŽ¥ ' : '';
                info.innerHTML = `<span class="image-name">${typeLabel}${mediaItem.name}</span>`;
                
                item.appendChild(checkbox);
                item.appendChild(mediaWrapper);
                item.appendChild(info);
                gallery.appendChild(item);
            });
            
            // Add checkbox listeners
            document.querySelectorAll('.image-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const item = e.target.closest('.image-item');
                    if (e.target.checked) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            });
        }
        
        // Search functionality
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            filteredMedia = allMedia.filter(item => 
                item.name.toLowerCase().includes(query)
            );
            renderGallery();
        });
        
        // Preview functionality
        function openPreview(mediaItem) {
            currentPreviewItem = mediaItem;
            
            const previewImage = document.getElementById('previewImage');
            const previewVideo = document.getElementById('previewVideo');
            const previewVideoSource = document.getElementById('previewVideoSource');
            
            if (mediaItem.type === 'video') {
                // Show video
                previewImage.style.display = 'none';
                previewVideo.style.display = 'block';
                
                const ext = mediaItem.name.split('.').pop().toLowerCase();
                const mimeTypes = {
                    'mp4': 'video/mp4',
                    'webm': 'video/webm',
                    'mov': 'video/quicktime',
                    'avi': 'video/x-msvideo',
                    'mkv': 'video/x-matroska',
                    'm4v': 'video/x-m4v'
                };
                
                previewVideoSource.src = `/media/${mediaItem.name}`;
                previewVideoSource.type = mimeTypes[ext] || 'video/mp4';
                previewVideo.load();
            } else {
                // Show image
                previewVideo.style.display = 'none';
                previewImage.style.display = 'block';
                previewImage.src = `/media/${mediaItem.name}`;
            }
            
            previewOverlay.classList.add('active');
            updateArrowButtons();
        }
        
        function updateArrowButtons() {
            const currentIndex = filteredMedia.findIndex(m => m.name === currentPreviewItem.name);
            const prevBtn = document.getElementById('previewPrev');
            const nextBtn = document.getElementById('previewNext');
            
            prevBtn.disabled = currentIndex <= 0;
            nextBtn.disabled = currentIndex >= filteredImages.length - 1;
        }
        
        function navigatePreview(direction) {
            const currentIndex = filteredMedia.findIndex(m => m.name === currentPreviewItem.name);
            let newIndex = currentIndex + direction;
            
            if (newIndex >= 0 && newIndex < filteredMedia.length) {
                openPreview(filteredMedia[newIndex]);
            }
        }
        
        previewClose.onclick = () => {
            previewOverlay.classList.remove('active');
        };
        
        previewOverlay.onclick = (e) => {
            if (e.target === previewOverlay) {
                previewOverlay.classList.remove('active');
            }
        };
        
        // Arrow button handlers
        document.getElementById('previewPrev').onclick = () => navigatePreview(-1);
        document.getElementById('previewNext').onclick = () => navigatePreview(1);
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (previewOverlay.classList.contains('active')) {
                if (e.key === 'ArrowLeft') {
                    navigatePreview(-1);
                } else if (e.key === 'ArrowRight') {
                    navigatePreview(1);
                } else if (e.key === 'Escape') {
                    previewOverlay.classList.remove('active');
                }
            }
        });
        
        previewDownload.onclick = () => {
            const link = document.createElement('a');
            link.href = `/media/${currentPreviewItem.name}`;
            link.download = currentPreviewItem.name;
            link.click();
        };
        
        // Upload functionality
        uploadBtn.onclick = () => {
            fileInput.click();
        };
        
        fileInput.onchange = async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = `Uploading ${files.length} file(s)...`;
            
            try {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }
                
                const response = await fetch('/api/media/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert(`${files.length} file(s) uploaded successfully!`);
                    fetchMedia(); // Refresh gallery
                } else {
                    const error = await response.text();
                    alert('Upload failed: ' + error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
                fileInput.value = ''; // Reset file input
            }
        };
        
        // Download all functionality
        downloadAllBtn.onclick = async () => {
            if (allMedia.length === 0) {
                alert('No media to download');
                return;
            }
            
            downloadAllBtn.disabled = true;
            downloadAllBtn.textContent = 'Downloading...';
            
            try {
                const zip = new JSZip();
                const promises = allMedia.map(async (mediaItem) => {
                    const response = await fetch(`/media/${mediaItem.name}`);
                    const blob = await response.blob();
                    zip.file(mediaItem.name, blob);
                });
                
                await Promise.all(promises);
                
                const content = await zip.generateAsync({type: 'blob'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'media.zip';
                link.click();
            } catch (error) {
                console.error('Error creating zip:', error);
                alert('Error downloading images');
            } finally {
                downloadAllBtn.disabled = false;
                downloadAllBtn.textContent = 'Download All';
            }
        };
        
        // Admin functionality
        adminBtn.onclick = () => {
            loginModal.classList.add('active');
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.style.display = 'none';
        };
        
        cancelLoginBtn.onclick = () => {
            loginModal.classList.remove('active');
        };
        
        loginBtn.onclick = () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            if ((username === 'aj' && password === 'red') || 
                (username === 'kiyo' && password === 'blue')) {
                isAdminMode = true;
                localStorage.setItem('clipAdminMode', 'true');
                document.body.classList.add('admin-mode');
                loginModal.classList.remove('active');
                loginError.style.display = 'none';
            } else {
                loginError.textContent = 'Invalid credentials';
                loginError.style.display = 'block';
            }
        };
        
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });
        
        exitAdminBtn.onclick = () => {
            isAdminMode = false;
            localStorage.removeItem('clipAdminMode');
            document.body.classList.remove('admin-mode');
            // Uncheck all checkboxes
            document.querySelectorAll('.image-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('.image-item').classList.remove('selected');
            });
        };
        
        deleteSelectedBtn.onclick = async () => {
            const selected = Array.from(document.querySelectorAll('.image-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selected.length === 0) {
                alert('No images selected');
                return;
            }
            
            if (!confirm(`Delete ${selected.length} image(s)?`)) {
                return;
            }
            
            deleteSelectedBtn.disabled = true;
            deleteSelectedBtn.textContent = 'Deleting...';
            
            try {
                const response = await fetch('/api/media/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'aj',
                        password: 'red',
                        files: selected
                    })
                });
                
                if (response.ok) {
                    // Remove deleted images from arrays
                    allImages = allImages.filter(img => !selected.includes(img));
                    filteredImages = filteredImages.filter(img => !selected.includes(img));
                    renderGallery();
                    alert(`${selected.length} image(s) deleted successfully`);
                } else {
                    const error = await response.text();
                    alert('Error deleting images: ' + error);
                }
            } catch (error) {
                console.error('Error deleting images:', error);
                alert('Error deleting images');
            } finally {
                deleteSelectedBtn.disabled = false;
                deleteSelectedBtn.textContent = 'Delete Selected';
            }
        };
        
        // View mode toggle
        const viewModeBtn = document.getElementById('viewModeBtn');
        viewModeBtn.onclick = () => {
            const modes = ['small', 'medium', 'large', 'list'];
            const currentIndex = modes.indexOf(viewMode);
            viewMode = modes[(currentIndex + 1) % modes.length];
            localStorage.setItem('mediaViewMode', viewMode);
            
            // Update button text
            const modeIcons = {small: 'âŠž', medium: 'âŠŸ', large: 'âŠ ', list: 'â˜°'};
            viewModeBtn.innerHTML = modeIcons[viewMode];
            viewModeBtn.title = `View: ${viewMode}`;
            
            renderGallery();
        };
        
        // Set initial button icon
        const modeIcons = {small: 'âŠž', medium: 'âŠŸ', large: 'âŠ ', list: 'â˜°'};
        viewModeBtn.innerHTML = modeIcons[viewMode];
        viewModeBtn.title = `View: ${viewMode}`;
        
        // Initialize
        fetchMedia();
        
        // Check if URL has focus parameter
        const urlParams = new URLSearchParams(window.location.search);
        const focusItem = urlParams.get('focus');
        if (focusItem) {
            // Wait for media to load, then open preview
            setTimeout(() => {
                const mediaItem = allMedia.find(m => m.name === focusItem);
                if (mediaItem) {
                    openPreview(mediaItem);
                }
            }, 500);
        }
    </script>
</body>
</html>

